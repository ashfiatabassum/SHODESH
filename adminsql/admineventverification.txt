SHODESH â€” Admin Event Verification: DBMS Code Map (Full, Structured)
======================================================================

A) Application Layer (JOIN Queries in Routes)
---------------------------------------------

Type: ROUTE (JOIN + FILTERS)
Purpose: List events for admin verification with filters, taxonomy joins, creator joins
Used in: src/routes/admin.js : /events (GET)
Definition:
router.get('/events', authenticateAdmin, async (req, res) => {
  try {
    const {
      status = '',
      category_id = '',
      event_type_id = '',
      ebc_id = '',
      creator_type = '',
      sort_by = 'recent',
      limit = 100,
      offset = 0,
    } = req.query;
    let sql = `
      SELECT 
        ec.creation_id,
        ec.creator_type,
        CASE 
          WHEN ec.creator_type='individual' THEN CONCAT(COALESCE(i.first_name,''),' ',COALESCE(i.last_name,''))
          WHEN ec.creator_type='foundation' THEN COALESCE(f.foundation_name,'')
          ELSE 'Unknown Creator'
        END AS creator_name,
        ec.individual_id,
        ec.foundation_id,
        ec.title,
        ec.description,
        ec.amount_needed,
        ec.amount_received,
        ec.division,
        ec.verification_status,
        ec.lifecycle_status,
        ec.second_verification_required,
        ec.created_at,
        ebc.ebc_id,
        c.category_id, c.category_name,
        et.event_type_id, et.event_type_name,
        CASE WHEN ec.cover_photo IS NOT NULL THEN 1 ELSE 0 END AS has_cover_photo,
        CASE WHEN ec.doc IS NOT NULL THEN 1 ELSE 0 END AS has_document
      FROM EVENT_CREATION ec
      JOIN EVENT_BASED_ON_CATEGORY ebc ON ebc.ebc_id = ec.ebc_id
      JOIN CATEGORY c ON c.category_id = ebc.category_id
      JOIN EVENT_TYPE et ON et.event_type_id = ebc.event_type_id
      LEFT JOIN INDIVIDUAL i ON i.individual_id = ec.individual_id
      LEFT JOIN FOUNDATION f ON f.foundation_id = ec.foundation_id
      WHERE 1=1`;
    // ...existing code for filters and execution...
  } catch (error) {
    // ...error handling...
  }
});

Type: ROUTE (JOIN + SUBQUERIES)
Purpose: Get event details with donation stats for a single event
Used in: src/routes/admin.js : /events/:id/details (GET)
Definition:
router.get('/events/:id/details', authenticateAdmin, async (req, res) => {
  try {
    const { id } = req.params;
    const [rows] = await adminDb.execute(`
      SELECT
        ec.creation_id,
        ec.title,
        ec.description,
        ec.amount_needed,
        ec.amount_received,
        ec.division,
        ec.verification_status,
        ec.lifecycle_status,
        ec.created_at,
        ec.updated_at,
        (ec.cover_photo IS NOT NULL) AS has_cover_photo,
        (ec.doc IS NOT NULL) AS has_document,
        ebc.ebc_id,
        c.category_id, c.category_name,
        et.event_type_id, et.event_type_name,
        ec.creator_type,
        CASE WHEN ec.creator_type='individual' THEN CONCAT(i.first_name,' ',i.last_name) ELSE f.foundation_name END AS creator_name,
        CASE WHEN ec.creator_type='individual' THEN i.mobile ELSE f.mobile END AS contact_phone,
        CASE WHEN ec.creator_type='individual' THEN i.email  ELSE f.email  END AS contact_email,
        (SELECT COUNT(*) FROM DONATION d WHERE d.creation_id=ec.creation_id) AS total_donors,
        (SELECT COALESCE(SUM(d.amount),0) FROM DONATION d WHERE d.creation_id=ec.creation_id) AS total_raised,
        (SELECT MAX(d.paid_at) FROM DONATION d WHERE d.creation_id=ec.creation_id) AS last_donation_at
      FROM EVENT_CREATION ec
      JOIN EVENT_BASED_ON_CATEGORY ebc ON ebc.ebc_id = ec.ebc_id
      JOIN CATEGORY c ON c.category_id = ebc.category_id
      JOIN EVENT_TYPE et ON et.event_type_id = ebc.event_type_id
      LEFT JOIN INDIVIDUAL i ON i.individual_id = ec.individual_id
      LEFT JOIN FOUNDATION f ON f.foundation_id = ec.foundation_id
      WHERE ec.creation_id = ?
    `, [id]);
    // ...existing code for result handling...
  } catch (error) {
    // ...error handling...
  }
});


B) Views
--------

Type: VIEW
Purpose: List events pending staff verification
Used in: sql/06_create_views_part1.sql, src/routes/admin.js : /events/pending-staff (GET)
Definition:
DROP VIEW IF EXISTS v_events_pending_staff_verification;
CREATE VIEW v_events_pending_staff_verification AS
SELECT 
    ec.creation_id,
    ec.title,
    ec.description,
    ec.amount_needed,
    ec.division,
    ec.creator_type,
    CASE 
        WHEN ec.creator_type = 'individual' THEN CONCAT(i.first_name, ' ', i.last_name)
        ELSE f.foundation_name
    END as creator_name,
    ec.created_at,
    ev.target_division,
    ev.verified_at as admin_decision_at
FROM EVENT_CREATION ec
JOIN EVENT_VERIFICATION ev ON ec.creation_id = ev.creation_id
LEFT JOIN INDIVIDUAL i ON ec.individual_id = i.individual_id
LEFT JOIN FOUNDATION f ON f.foundation_id = ec.foundation_id
WHERE ec.verification_status = 'pending' 
  AND ec.second_verification_required = 1
  AND ev.round_no = 1 
  AND ev.decision = 'request_staff_verification';

Type: VIEW
Purpose: List events pending final admin approval
Used in: sql/07_create_views_part2.sql, src/routes/admin.js : /events/pending-admin-final (GET)
Definition:
DROP VIEW IF EXISTS v_events_pending_admin_final;
CREATE VIEW v_events_pending_admin_final AS
SELECT 
    ec.creation_id,
    ec.title,
    ec.description,
    ec.amount_needed,
    ec.division,
    ec.creator_type,
    CASE 
        WHEN ec.creator_type = 'individual' THEN CONCAT(i.first_name, ' ', i.last_name)
        ELSE f.foundation_name
    END as creator_name,
    ec.created_at,
    s.first_name as staff_first_name,
    s.last_name as staff_last_name,
    ev.verified_at as staff_approval_at
FROM EVENT_CREATION ec
JOIN EVENT_VERIFICATION ev ON ec.creation_id = ev.creation_id
LEFT JOIN INDIVIDUAL i ON ec.individual_id = i.individual_id
LEFT JOIN FOUNDATION f ON f.foundation_id = ec.foundation_id
LEFT JOIN STAFF s ON ev.staff_id = s.staff_id
WHERE ec.verification_status = 'pending' 
  AND ec.second_verification_required = 0
  AND ev.round_no = 2
  AND ev.decision = 'approved';

Type: VIEW
Purpose: List staff eligible for event verification
Used in: sql/08_create_views_part3.sql, src/routes/admin.js : /events/:id/available-staff (GET)
Definition:
DROP VIEW IF EXISTS v_available_staff_for_verification;
CREATE VIEW v_available_staff_for_verification AS
SELECT DISTINCT
    s.staff_id,
    s.first_name,
    s.last_name,
    s.username,
    s.administrative_div as division,
    ec.creation_id,
    ec.title as event_title,
    ec.division as event_division
FROM STAFF s
CROSS JOIN EVENT_CREATION ec
WHERE s.status = 'verified'
  AND ec.verification_status = 'pending'
  AND ec.second_verification_required = 1
  AND ec.creator_type = 'individual'
  AND (s.administrative_div = ec.division OR s.administrative_div = CONCAT(ec.division, ' Division'))
  AND fn_can_staff_verify_event(s.staff_id, ec.creation_id) = TRUE;


C) Functions
------------

Type: FUNCTION
Purpose: Check if a staff member is eligible to verify a given event
Used in: v_available_staff_for_verification (view), src/routes/admin.js : /events/:id/available-staff (GET)
Definition:
DELIMITER //
CREATE FUNCTION fn_can_staff_verify_event(staffId INT, eventId INT) RETURNS BOOLEAN
BEGIN
    DECLARE canVerify BOOLEAN DEFAULT FALSE;
    -- Logic to check eligibility
    IF EXISTS (
        SELECT 1 FROM STAFF_ASSIST sa
        WHERE sa.staff_id = staffId AND sa.event_id = eventId
    ) THEN
        SET canVerify = FALSE;
    ELSE
        SET canVerify = TRUE;
    END IF;
    RETURN canVerify;
END //
DELIMITER ;

Type: FUNCTION
Purpose: Get a summary of verification status for an event
Used in: src/routes/admin.js : /events/:id/details (GET)
Definition:
DELIMITER //
CREATE FUNCTION fn_get_verification_status_summary(eventId INT) RETURNS VARCHAR(255)
BEGIN
    DECLARE summary VARCHAR(255);
    -- Logic to summarize status
    SELECT CONCAT('Status: ', verification_status) INTO summary
    FROM EVENT_CREATION WHERE creation_id = eventId;
    RETURN summary;
END //
DELIMITER ;

D) Procedures
-------------

Type: PROCEDURE
Purpose: Admin verifies an event (first or final round)
Used in: src/routes/admin.js : /events/:id/verify (POST)
Definition:
DELIMITER //
CREATE PROCEDURE sp_admin_verify_event(
    IN p_creation_id INT,
    IN p_admin_id INT,
    IN p_decision VARCHAR(20),
    IN p_comment TEXT
)
BEGIN
    -- Logic for admin verification
    INSERT INTO EVENT_VERIFICATION (creation_id, admin_id, decision, comment, verified_at, round_no)
    VALUES (p_creation_id, p_admin_id, p_decision, p_comment, NOW(), 1);
    -- ...additional logic...
END //
DELIMITER ;

Type: PROCEDURE
Purpose: Staff verifies an event (second round, if required)
Used in: src/routes/admin.js : /events/:id/staff-verify (POST)
Definition:
DELIMITER //
CREATE PROCEDURE sp_staff_verify_event(
    IN p_creation_id INT,
    IN p_staff_id INT,
    IN p_decision VARCHAR(20),
    IN p_comment TEXT
)
BEGIN
    -- Logic for staff verification
    INSERT INTO EVENT_VERIFICATION (creation_id, staff_id, decision, comment, verified_at, round_no)
    VALUES (p_creation_id, p_staff_id, p_decision, p_comment, NOW(), 2);
    -- ...additional logic...
END //
DELIMITER ;

E) Triggers
-----------

Type: TRIGGER
Purpose: Enforce event verification business rules before insert
Used in: EVENT_VERIFICATION table (all inserts)
Definition:
DELIMITER //
CREATE TRIGGER BI_EVENT_VERIFICATION_ENFORCE
BEFORE INSERT ON EVENT_VERIFICATION
FOR EACH ROW
BEGIN
    -- Business rule enforcement logic
    IF NEW.decision NOT IN ('approved', 'rejected', 'request_staff_verification') THEN
        SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Invalid decision value';
    END IF;
END //
DELIMITER ;

Type: TRIGGER
Purpose: Apply event verification effects after insert
Used in: EVENT_VERIFICATION table (all inserts)
Definition:
DELIMITER //
CREATE TRIGGER AI_EVENT_VERIFICATION_APPLY
AFTER INSERT ON EVENT_VERIFICATION
FOR EACH ROW
BEGIN
    -- Logic to update EVENT_CREATION status
    IF NEW.decision = 'approved' THEN
        UPDATE EVENT_CREATION SET verification_status = 'approved' WHERE creation_id = NEW.creation_id;
    ELSEIF NEW.decision = 'rejected' THEN
        UPDATE EVENT_CREATION SET verification_status = 'rejected' WHERE creation_id = NEW.creation_id;
    END IF;
END //
DELIMITER ;

-- END OF FILE --
