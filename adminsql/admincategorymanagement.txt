SHODESH — Admin Category Management: DBMS Code Map
=================================================
Short feature description: Admins manage the campaign taxonomy by defining Categories, Event Types, and their relationships (EVENT_BASED_ON_CATEGORY). Backend exposes list, create/link, and delete endpoints with usage checks and transactions. Event records reference the junction key (ebc_id) to bind a campaign to a Category×EventType pair.

Format per item:
Type: <CONSTRAINT|SIMPLE QUERY|COMPLEX QUERY|JOIN|SUBQUERY|VIEW|FUNCTION|PROCEDURE|TRIGGER|TRANSACTION|SEQUENCE|GRANT/REVOKE|EXCEPTION|DML>
Purpose: <short purpose>
Used in: <file path> : <line(s)>
Tables involved: <table names>
Definition: <exact SQL or route snippet>

A) Routes and Queries (Application Layer)
----------------------------------------
1) List categories with aggregated event types
Type: JOIN + AGGREGATION (GROUP_CONCAT)
Purpose: Admin overview showing each category and its event types
Used in: src/routes/admin.js : 1239–1262
Tables involved: CATEGORY, EVENT_BASED_ON_CATEGORY, EVENT_TYPE
Definition (route SQL):
SELECT 
  c.category_id, c.category_name,
  GROUP_CONCAT(et.event_type_name ORDER BY et.event_type_name) AS event_type_names,
  GROUP_CONCAT(et.event_type_id ORDER BY et.event_type_name) AS event_type_ids
FROM CATEGORY c
LEFT JOIN EVENT_BASED_ON_CATEGORY ebc ON ebc.category_id = c.category_id
LEFT JOIN EVENT_TYPE et ON et.event_type_id = ebc.event_type_id
GROUP BY c.category_id, c.category_name
ORDER BY c.category_name;

2) Delete category (guarded by usage)
Type: JOIN + EXCEPTION (application)
Purpose: Prevent deletion if any events reference the category via EBC; otherwise remove links then the category
Used in: src/routes/admin.js : 1269–1287
Tables involved: EVENT_CREATION, EVENT_BASED_ON_CATEGORY, CATEGORY
Definition (route SQL):
SELECT COUNT(*) AS cnt
FROM EVENT_CREATION ec
JOIN EVENT_BASED_ON_CATEGORY ebc ON ec.ebc_id = ebc.ebc_id
WHERE ebc.category_id = ?;
-- if cnt > 0 → 400 Cannot delete category in use by events
DELETE FROM EVENT_BASED_ON_CATEGORY WHERE category_id = ?;
DELETE FROM CATEGORY WHERE category_id = ?;

3) Create category with event types (transaction)
Type: TRANSACTION + DML
Purpose: Insert CATEGORY; ensure EVENT_TYPEs; link via EVENT_BASED_ON_CATEGORY
Used in: src/routes/admin.js : 1294–1344
Tables involved: CATEGORY, EVENT_TYPE, EVENT_BASED_ON_CATEGORY
Definition (route SQL — outline):
INSERT INTO CATEGORY (category_id, category_name) VALUES (?, ?);
INSERT IGNORE INTO EVENT_TYPE (event_type_id, event_type_name) VALUES (?, ?);
SELECT event_type_id FROM EVENT_TYPE WHERE event_type_name = ?;
INSERT IGNORE INTO EVENT_BASED_ON_CATEGORY (ebc_id, category_id, event_type_id) VALUES (?, ?, ?);

4) Add an event type to a category (transaction)
Type: TRANSACTION + DML
Purpose: Ensure EVENT_TYPE exists; create EBC link if missing
Used in: src/routes/admin.js : 1349–1410
Tables involved: EVENT_TYPE, EVENT_BASED_ON_CATEGORY
Definition (route SQL — outline):
INSERT IGNORE INTO EVENT_TYPE (event_type_id, event_type_name) VALUES (?, ?);
SELECT event_type_id FROM EVENT_TYPE WHERE event_type_name = ?;
INSERT IGNORE INTO EVENT_BASED_ON_CATEGORY (ebc_id, category_id, event_type_id) VALUES (?, ?, ?);

B) DBMS Objects (Schema Layer)
------------------------------
1) Tables (exact SQL) — sql/shodeshsqlscript.sql : 198–236
Type: CONSTRAINT
Purpose: Define taxonomy and junction with PK/UK/FK
Tables involved: CATEGORY, EVENT_TYPE, EVENT_BASED_ON_CATEGORY
Definition (full):
CREATE TABLE CATEGORY (
  category_id    VARCHAR(7)  NOT NULL,
  category_name  VARCHAR(50) NOT NULL,
  CONSTRAINT CATEGORY_PK PRIMARY KEY (category_id),
  CONSTRAINT CATEGORY_NAME_U UNIQUE (category_name)
);

CREATE TABLE EVENT_TYPE (
  event_type_id   VARCHAR(7)  NOT NULL,
  event_type_name VARCHAR(50) NOT NULL,
  CONSTRAINT EVENT_TYPE_PK PRIMARY KEY (event_type_id),
  CONSTRAINT EVENT_TYPE_NAME_U UNIQUE (event_type_name)
);

CREATE TABLE EVENT_BASED_ON_CATEGORY (
  ebc_id        VARCHAR(7) NOT NULL,
  category_id   VARCHAR(7) NOT NULL,
  event_type_id VARCHAR(7) NOT NULL,
  CONSTRAINT EBC_PK PRIMARY KEY (ebc_id),
  CONSTRAINT EBC_PAIR_U UNIQUE (category_id, event_type_id),
  CONSTRAINT EBC_CATEGORY_FK   FOREIGN KEY (category_id)   REFERENCES CATEGORY(category_id)
    ON DELETE RESTRICT ON UPDATE CASCADE,
  CONSTRAINT EBC_EVENT_TYPE_FK FOREIGN KEY (event_type_id) REFERENCES EVENT_TYPE(event_type_id)
    ON DELETE RESTRICT ON UPDATE CASCADE
);

2) Views (exact SQL) — sql/shodeshsqlscript.sql : 985–1056
Type: VIEW
Purpose: Expose category/event_type per event; support filter dropdowns
Tables involved: EVENT_CREATION, EVENT_BASED_ON_CATEGORY, CATEGORY, EVENT_TYPE, INDIVIDUAL, FOUNDATION
Definition (key parts):
CREATE VIEW v_event_catalog AS
SELECT ec.creation_id, ec.title, ec.verification_status, ec.lifecycle_status,
       ebc.ebc_id, cat.category_id, cat.category_name, et.event_type_id, et.event_type_name,
       ec.creator_type
FROM EVENT_CREATION ec
JOIN EVENT_BASED_ON_CATEGORY ebc ON ebc.ebc_id = ec.ebc_id
LEFT JOIN CATEGORY cat ON cat.category_id = ebc.category_id
LEFT JOIN EVENT_TYPE et ON et.event_type_id = ebc.event_type_id
LEFT JOIN INDIVIDUAL i ON i.individual_id = ec.individual_id
LEFT JOIN FOUNDATION f ON f.foundation_id = ec.foundation_id;

CREATE VIEW v_event_catalog_open AS
SELECT * FROM v_event_catalog
WHERE verification_status = 'verified' AND lifecycle_status = 'active';

CREATE VIEW v_event_filters_categories AS
SELECT DISTINCT category_id, category_name
FROM v_event_catalog_open
WHERE category_id IS NOT NULL
ORDER BY category_name;

CREATE VIEW v_event_filters_event_types AS
SELECT DISTINCT event_type_id, event_type_name, category_id
FROM v_event_catalog_open
WHERE event_type_id IS NOT NULL
ORDER BY event_type_name;

3) Procedure — sp_get_event_types (exact SQL) — sql/shodeshsqlscript.sql : 1074–1082
Type: PROCEDURE
Purpose: List event types; optionally filter by category via views
Tables involved: v_event_filters_event_types
Definition (full):
DROP PROCEDURE IF EXISTS sp_get_event_types $$
CREATE PROCEDURE sp_get_event_types(IN p_category_id VARCHAR(7))
BEGIN
  SELECT event_type_id, event_type_name
  FROM v_event_filters_event_types
  WHERE (p_category_id IS NULL OR p_category_id = '' OR category_id = p_category_id);
END $$

C) Constraints and Data Types
-----------------------------
- Keys & Uniqueness: CATEGORY_PK, EVENT_TYPE_PK, EBC_PK; CATEGORY_NAME_U; EVENT_TYPE_NAME_U; EBC_PAIR_U
- Referential: EBC_CATEGORY_FK → CATEGORY(category_id) RESTRICT; EBC_EVENT_TYPE_FK → EVENT_TYPE(event_type_id) RESTRICT
- Referential usage: EVENT_CREATION.ebc_id → EVENT_BASED_ON_CATEGORY.ebc_id (prevents deleting in-use categories)

D) Grants and Exceptions
------------------------
- Grant: GRANT SELECT ON shodesh.* TO 'root'@'localhost' (sql/shodeshsqlscript.sql : ~7)
- Exception (application): 400 when deleting a category referenced by EVENT_CREATION
- Transactions: BEGIN/COMMIT/ROLLBACK around create/link operations; 500 on failure with message

E) Frontend References
----------------------
- Admin UI renders categories grid (local stub): src/public/admin/admin-frontend.js : 380–460
- Category actions (stubs/local): src/public/admin/admin-frontend.js : 600–660
- TODO: Wire to APIs
  • GET /api/admin/categories/events — render list
  • POST /api/admin/categories/full — create category + event types
  • POST /api/admin/categories/:categoryId/add-event-type — extend
  • DELETE /api/admin/categories/:categoryId — remove if unused

F) Short Summary
----------------
Category Management models the taxonomy via CATEGORY, EVENT_TYPE, and the EBC junction. Admin routes list, create, and safely delete categories, using transactions and usage guards. Views power filters across the site; a simple procedure exposes event types for a selected category.
