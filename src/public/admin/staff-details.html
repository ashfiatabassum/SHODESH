<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Staff Details</title>
  <link rel="stylesheet" href="../admin/admin.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <style>
    .page { max-width: 900px; margin: 90px auto 40px; padding: 0 16px; }
    .topbar { position:fixed; top:0; left:0; right:0; height:70px; display:flex; align-items:center; background:#fff; border-bottom:1px solid #e2e8f0; padding:0 16px; z-index:10; }
    .topbar a { color:#4a7c59; text-decoration:none; font-weight:600; }
    .card { background:#fff; border:1px solid #e2e8f0; border-radius:12px; padding:16px; box-shadow:0 1px 3px rgba(0,0,0,.06); }
    .grid { display:grid; grid-template-columns: repeat(2, 1fr); gap:14px; }
    .row { display:flex; gap:8px; }
    .row label { width:170px; color:#718096; }
    .actions { display:flex; gap:8px; margin-top:16px; }
    .btn { padding:8px 12px; border:none; border-radius:6px; font-weight:600; cursor:pointer; }
    .btn-approve { background:#c6f6d5; color:#22543d; }
    .btn-reject { background:#fed7d7; color:#c53030; }
    .btn-unsuspend { background:#e6f3ff; color:#2b6cb0; }
  </style>
</head>
<body>
  <div class="topbar">
    <a href="./staff-verification.html">‚Üê Back to Staff Verification</a>
  </div>
  <div class="page" aria-live="polite">
    <h1 style="margin-bottom:12px">Staff Details</h1>
    <div id="card" class="card"></div>
  </div>

  <script>
    const apiBase = '/api/admin';
    const token = localStorage.getItem('adminToken');
    if (!token) {
      alert('Please login as admin first.');
      window.location.href = './index.html';
    }

    function getParam(key){ const u=new URL(location.href); return u.searchParams.get(key); }

    async function apiRequest(endpoint, options={}) {
      const res = await fetch(apiBase + endpoint, {
        ...options,
        headers: {
          'Content-Type': 'application/json',
          'Authorization': token,
          ...(options.headers||{})
        }
      });
      if (res.status === 401) { alert('Session expired. Login again.'); location.href='./index.html'; return null; }
      return res.json();
    }

    function row(label, value){
      return `<div class="row"><label>${label}</label><div>${value ?? ''}</div></div>`;
    }

    function renderDetails(d){
      const fullName = (d.first_name && d.last_name) ? `${d.first_name} ${d.last_name}` : (d.username||'');
      const card = document.getElementById('card');
      card.innerHTML = `
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
          <div style="font-weight:600; font-size:18px;">${fullName} <span class="badge ${d.status}">${d.status}</span></div>
          <div class="actions" style="gap:8px; display:flex; flex-wrap:wrap;">
            ${d.status==='unverified' ? `
              <button class="btn btn-approve" type="button" title="Approve staff" aria-label="Approve staff" onclick="verifyStaff('${d.staff_id}','verify', this)"><i class='fas fa-check' aria-hidden="true"></i> Approve</button>
              <button class="btn btn-reject" type="button" title="Reject and delete" aria-label="Reject and delete" onclick="deleteStaff('${d.staff_id}')"><i class='fas fa-trash' aria-hidden="true"></i> Reject</button>
            `:''}
            ${d.status==='verified' ? '' : ''}
            ${d.status==='suspended' ? `
              <button class="btn btn-unsuspend" type="button" title="Unsuspend staff" aria-label="Unsuspend staff" onclick="verifyStaff('${d.staff_id}','unsuspend', this)"><i class='fas fa-unlock' aria-hidden="true"></i> Unsuspend</button>
              <button class="btn btn-reject" type="button" title="Delete permanently" aria-label="Delete permanently" onclick="deleteStaff('${d.staff_id}')"><i class='fas fa-trash' aria-hidden="true"></i> Delete</button>
            `:''}
            ${d.has_cv?`<button class="btn" type="button" style="background:#edf2f7;color:#2d3748" title="Download CV" aria-label="Download CV" onclick="downloadCV('${d.staff_id}')"><i class='fas fa-file-arrow-down' aria-hidden="true"></i> Download CV</button>`:''}
          </div>
        </div>
        <div class="grid">
          <div>
            ${row('Staff ID', d.staff_id)}
            ${row('Username', d.username)}
            ${row('Email', d.email)}
            ${row('Mobile', d.mobile)}
            ${row('NID', d.nid)}
            ${row('Date of Birth', d.dob)}
          </div>
          <div>
            ${row('House No', d.house_no)}
            ${row('Road No', d.road_no)}
            ${row('Area', d.area)}
            ${row('District', d.district)}
            ${row('Division', d.administrative_div)}
            ${row('ZIP', d.zip)}
          </div>
        </div>
        <div style="margin-top:12px; color:#718096;">CV: ${d.has_cv ? (d.cv_size + ' bytes') : 'not uploaded'}</div>
      `;
    }

    async function verifyStaff(id, action, btn){
      if (!confirm(`Are you sure you want to ${action} this staff?`)) return;
      // Disable button(s) and show spinner text
      const buttons = document.querySelectorAll('.actions .btn');
      buttons.forEach(b => { b.disabled = true; b.dataset.orig = b.innerHTML; b.innerHTML = `<i class='fas fa-spinner fa-spin'></i> Processing...`; });
      const resp = await apiRequest(`/staff/${encodeURIComponent(id)}/verify`, {
        method: 'PUT', body: JSON.stringify({ action, notes: action })
      }).catch(() => null);
      if (!resp || !resp.success) {
        alert(resp?.message || 'Action failed');
        buttons.forEach(b => { b.disabled = false; if (b.dataset.orig) b.innerHTML = b.dataset.orig; });
        return;
      }
      // Reload details to reflect new status
      await loadDetails();
    }
    window.verifyStaff = verifyStaff;

    async function deleteStaff(id){
      if (!confirm('This will permanently remove the staff record. Continue?')) return;
      try {
        const res = await fetch(`${apiBase}/staff/${encodeURIComponent(id)}`, { method: 'DELETE', headers: { 'Authorization': token } });
        const json = await res.json().catch(() => null);
        if (!res.ok || !json?.success) throw new Error(json?.message || 'Delete failed');
        alert('Staff deleted');
        window.location.href = './staff-verification.html';
      } catch (e) { alert(e.message || 'Delete failed'); }
    }
    window.deleteStaff = deleteStaff;

    async function downloadCV(id){
      try {
        const res = await fetch(`${apiBase}/staff/${encodeURIComponent(id)}/cv`, { headers: { 'Authorization': token } });
        if (!res.ok) throw new Error('Failed to download CV');
        const blob = await res.blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `staff_${id}_cv`;
        document.body.appendChild(a);
        a.click();
        URL.revokeObjectURL(url);
        a.remove();
      } catch (e) { alert(e.message || 'Download failed'); }
    }
    window.downloadCV = downloadCV;

    async function loadDetails(){
      const id = getParam('staff_id');
      if (!id) { alert('Missing staff_id'); location.href='./staff-verification.html'; return; }
      const data = await apiRequest(`/staff/${encodeURIComponent(id)}/details`);
      if (!data || !data.success) { alert('Failed to load staff'); location.href='./staff-verification.html'; return; }
      renderDetails(data.data);
    }

    document.addEventListener('DOMContentLoaded', async () => {
      await loadDetails();
    });
  </script>
</body>
</html>
